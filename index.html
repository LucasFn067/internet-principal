<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Links - Prefeitura de Gua√≠ba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #374151 0%, #1f2937 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .alert-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">Sistema de Gerenciamento de Links</h1>
            <p class="text-center mt-2 opacity-90">Prefeitura de Gua√≠ba - Preg√£o Eletr√¥nico 71/2022</p>
        </div>
    </header>

    <!-- Navega√ß√£o entre Pain√©is - Movido para o topo -->
    <div class="bg-gray-800 border-b border-gray-700 py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center gap-4 mb-4">
                <button id="mainPanelBtn" onclick="showPanel('main')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    üè† Painel Principal
                </button>
                <button id="itinerantPanelBtn" onclick="showPanel('itinerant')" class="bg-gray-400 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                    üì° Links Itinerantes
                </button>
                <button id="hotspotPanelBtn" onclick="showPanel('hotspot')" class="bg-gray-400 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition">
                    üì∂ Links de Hotspot
                </button>
            </div>
            
            <!-- Bot√µes de Exporta√ß√£o -->
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="exportToPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    üìÑ Exportar PDF
                </button>
                <button onclick="exportToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    üìä Exportar CSV
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Dashboard Principal -->
        <div class="grid grid-cols-1 gap-6 mb-8">
            <!-- Painel de Status -->
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-semibold mb-6 text-gray-100">üìä Dashboard</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="totalLinks">0</div>
                        <div class="text-sm text-gray-600">Links Externos</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="totalBandwidth">0</div>
                        <div class="text-sm text-gray-600">Mbps Total</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-600" id="concentratorCapacity">100</div>
                        <div class="text-sm text-gray-600">Concentrador</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg text-center">
                        <div class="text-lg font-bold" id="upgradeStatus">‚úÖ</div>
                        <div class="text-sm text-gray-600">Status</div>
                    </div>
                </div>

                <!-- Alerta de Capacidade -->
                <div id="capacityAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 alert-pulse">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> <span id="alertMessage"></span>
                </div>


            </div>


        </div>

        <!-- Gerenciamento de Links -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Adicionar Link -->
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">‚ûï Adicionar Link Externo</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Nome do Link</label>
                        <input type="text" id="linkName" placeholder="Ex: Link Sede Principal" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Endere√ßo do Local</label>
                        <input type="text" id="linkAddress" placeholder="Ex: Rua das Flores, 123 - Centro" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Coordenadas GPS</label>
                        <input type="text" id="linkCoordinates" placeholder="Ex: -30.1234, -51.5678" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Velocidade (Mbps)</label>
                        <input type="number" id="linkSpeed" value="40" min="40" max="10000" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                        <div class="text-xs text-gray-400 mt-1">M√≠nimo: 40 Mbps | M√°ximo: 10.000 Mbps</div>
                    </div>
                    <button onclick="addLink()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition font-medium">
                        Adicionar Link
                    </button>
                </div>
            </div>

            <!-- Lista de Links -->
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">üîó Links Cadastrados</h2>
                
                <div id="linksList" class="space-y-3">
                    <div class="text-gray-500 text-center py-8">
                        Nenhum link cadastrado ainda
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Painel de Links Itinerantes -->
    <div id="itinerantPanel" class="container mx-auto px-4 py-8 hidden">
        <!-- Header do Painel Itinerante -->
        <div class="bg-gray-800 rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">üì° Gerenciamento de Links Itinerantes</h2>
            <p class="text-gray-400">Gerencie links itinerantes com m√∫ltiplas conex√µes para atingir velocidades superiores a 100 Mbps</p>
            
            <!-- Resumo dos Links Itinerantes -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600" id="totalItinerantLinks">0</div>
                    <div class="text-sm text-gray-600">Links Itinerantes</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalSubLinks">0</div>
                    <div class="text-sm text-gray-600">Sub-Links Ativos</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalItinerantBandwidth">0</div>
                    <div class="text-sm text-gray-600">Mbps Total</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="activeItinerantLinks">0</div>
                    <div class="text-sm text-gray-600">Links Ativos</div>
                </div>
            </div>
        </div>

        <!-- Adicionar Link Itinerante -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">‚ûï Adicionar Link Itinerante</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Nome do Link Itinerante</label>
                        <input type="text" id="itinerantLinkName" placeholder="Ex: Link Itinerante Evento Centro" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Localiza√ß√£o</label>
                        <input type="text" id="itinerantLocation" placeholder="Ex: Centro da Cidade" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Coordenadas GPS</label>
                        <input type="text" id="itinerantCoordinates" placeholder="Ex: -30.1234, -51.5678" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-200">Per√≠odo de Uso</label>
                        <input type="text" id="itinerantPeriodInput" placeholder="Ex: 01/01/2024 a 31/12/2024" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    
                    <!-- Configura√ß√µes de Acesso -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium mb-3 text-gray-200">üîß Configura√ß√µes de Acesso</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="itinerantPublicCheck" class="mr-2">
                                    <span class="text-sm font-medium text-gray-200">Para uso p√∫blico</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="itinerantWifiCheck" onchange="toggleWifiConfig()" class="mr-2">
                                    <span class="text-sm font-medium text-gray-200">Necessita Wi-Fi</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="itinerantLanCheck" class="mr-2">
                                    <span class="text-sm font-medium text-gray-200">Necessita Cabo LAN</span>
                                </label>
                            </div>
                            
                            <!-- Configura√ß√£o Wi-Fi -->
                            <div id="wifiConfig" class="hidden ml-6 space-y-2 bg-gray-700 p-3 rounded">
                                <div>
                                    <label class="block text-xs font-medium mb-1 text-gray-200">SSID (Nome da Rede)</label>
                                    <input type="text" id="wifiSSID" placeholder="Ex: Prefeitura_Guaiba_Evento" 
                                           class="w-full border border-gray-500 rounded px-2 py-1 text-sm bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium mb-1 text-gray-200">Senha</label>
                                    <input type="password" id="wifiPassword" placeholder="Digite a senha do Wi-Fi" 
                                           class="w-full border border-gray-500 rounded px-2 py-1 text-sm bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                                </div>
                            </div>
                        </div>
                    </div>
                    

                    <button onclick="addItinerantLink()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition">
                        Adicionar Link Itinerante
                    </button>
                </div>
            </div>

            <!-- Informa√ß√µes sobre Sub-Links -->
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">‚ÑπÔ∏è Informa√ß√µes</h3>
                
                <div class="space-y-4 text-sm text-gray-400">
                    <div class="bg-gray-700 p-3 rounded">
                        <strong>Limite por Sub-Link:</strong> 100 Mbps
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <strong>M√°ximo de Sub-Links:</strong> 100 por link itinerante
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <strong>Velocidade M√°xima:</strong> 10.000 Mbps (100 √ó 100 Mbps)
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <strong>Como funciona:</strong> Cada link itinerante pode ter m√∫ltiplas conex√µes f√≠sicas que se somam para atingir velocidades superiores.
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Links Itinerantes -->
        <div class="bg-gray-800 rounded-xl card-shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-100">üì° Links Itinerantes Cadastrados</h3>
                <div class="space-x-2">
                    <button onclick="exportItinerantToPDF()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm">
                        üìÑ PDF
                    </button>
                    <button onclick="exportItinerantToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                        üìä CSV
                    </button>
                </div>
            </div>
            
            <div id="itinerantLinksList" class="space-y-4">
                <div class="text-gray-500 text-center py-8">
                    Nenhum link itinerante cadastrado ainda
                </div>
            </div>
        </div>
    </div>

    <!-- Painel de Links de Hotspot -->
    <div id="hotspotPanel" class="container mx-auto px-4 py-8 hidden">
        <!-- Header do Painel Hotspot -->
        <div class="bg-gray-800 rounded-xl card-shadow p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">üì∂ Gerenciamento de Links de Hotspot</h2>
            <p class="text-gray-400">Gerencie pontos de acesso Wi-Fi para disponibilizar internet em locais p√∫blicos</p>
            
            <!-- Resumo dos Links de Hotspot -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="totalHotspotLinks">0</div>
                    <div class="text-sm text-gray-600">Links de Hotspot</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="activeHotspotLinks">0</div>
                    <div class="text-sm text-gray-600">Links Ativos</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalHotspotLocations">0</div>
                    <div class="text-sm text-gray-600">Localiza√ß√µes</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600" id="hotspotCoverage">0</div>
                    <div class="text-sm text-gray-600">Cobertura (%)</div>
                </div>
            </div>
        </div>

        <!-- Adicionar Link de Hotspot -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-100">‚ûï Adicionar Link de Hotspot</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nome do Hotspot</label>
                        <input type="text" id="hotspotLinkName" placeholder="Ex: Hotspot Pra√ßa Central" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Endere√ßo do Local</label>
                        <input type="text" id="hotspotAddress" placeholder="Ex: Pra√ßa da Matriz, s/n - Centro" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Coordenadas GPS</label>
                        <input type="text" id="hotspotCoordinates" placeholder="Ex: -30.1234, -51.5678" 
                               class="w-full border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:outline-none">
                    </div>

                    <button onclick="addHotspotLink()" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700 transition">
                        Adicionar Hotspot
                    </button>
                </div>
            </div>

            <!-- Informa√ß√µes sobre Hotspots -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">‚ÑπÔ∏è Informa√ß√µes sobre Hotspots</h3>
                
                <div class="space-y-4 text-sm text-gray-600">
                    <div class="bg-orange-50 p-3 rounded">
                        <strong>Finalidade:</strong> Fornecer acesso Wi-Fi gratuito em locais p√∫blicos
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <strong>Cobertura:</strong> 360 graus com alcance m√≠nimo de 180 metros de raio
                    </div>
                    <div class="bg-green-50 p-3 rounded">
                        <strong>Capacidade:</strong> 125 usu√°rios (Tipo I) ou 250 usu√°rios (Tipo II)
                    </div>
                    <div class="bg-yellow-50 p-3 rounded">
                        <strong>Velocidade:</strong> 1.000 Mbps por hotspot (soma no concentrador)
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <strong>Configura√ß√£o:</strong> Rede aberta com portal de autentica√ß√£o
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Links de Hotspot -->
        <div class="bg-white rounded-xl card-shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">üì∂ Hotspots Cadastrados</h3>
                <div class="space-x-2">
                    <button onclick="exportHotspotToPDF()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm">
                        üìÑ PDF
                    </button>
                    <button onclick="exportHotspotToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                        üìä CSV
                    </button>
                </div>
            </div>
            
            <div id="hotspotLinksList" class="space-y-4">
                <div class="text-gray-500 text-center py-8">
                    Nenhum hotspot cadastrado ainda
                </div>
            </div>
        </div>
    </div>

  <!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================
   CONFIGURA√á√ÉO SUPABASE
   =========================
   Substitua os valores abaixo pelo seu projeto do Supabase.
*/
const SUPABASE_URL = "https://sbanyijljmheokwsliec.supabase.co"; // <- substitua
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiYW55aWpsam1oZW9rd3NsaWVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NjQ4NDYsImV4cCI6MjA3MzU0MDg0Nn0.IxZIU0NH_uXa9ASuUWmlR_gwOpV8w02Hb3hApVn3Xew";         // <- substitua

// inicializa o client (global 'supabase' vem do UMD)
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   VARI√ÅVEIS GLOBAIS
   ========================= */
let links = [];
let concentratorCapacity = 100;
let itinerantLinks = [];
let hotspotLinks = [];
let currentPanel = 'main';
let config = {
    sla: 98.5,
    redundancy: false,
    itinerant: false,
    itinerantSpeed: 0,
    itinerantPeriod: '',
    wifiPoints: 0,
    wifiUsers: 0,
    ipv4Block: '',
    ipv6Block: ''
};

/* =========================
   INICIALIZA√á√ÉO
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  loadAll();
});

/* =========================
   LOAD ALL
   ========================= */
async function loadAll() {
  try {
    await Promise.all([
      loadLinks(),
      loadItinerantLinks(),
      loadHotspots()
    ]);
    updateDisplay();
    updateItinerantDisplay();
    updateHotspotDisplay();
  } catch (err) {
    console.error('Erro em loadAll', err);
  }
}

/* =========================
   LINKS EXTERNOS (CRUD)
   ========================= */
async function loadLinks() {
  try {
    const { data, error } = await supabase
      .from('links')
      .select('*')
      .order('date_created', { ascending: true });

    if (error) throw error;

    links = (data || []).map(r => ({
      id: r.id,
      name: r.name,
      address: r.address,
      coordinates: r.coordinates,
      speed: r.speed,
      dateCreated: r.date_created ? new Date(r.date_created).toLocaleDateString('pt-BR') : ''
    }));

    updateDisplay();
  } catch (err) {
    console.error('loadLinks error', err);
  }
}

async function addLink() {
  // l√™ campos do formul√°rio (IDs do seu HTML)
  const name = document.getElementById('linkName').value.trim();
  const address = document.getElementById('linkAddress').value.trim();
  const coordinates = document.getElementById('linkCoordinates').value.trim() || null;
  const speed = parseInt(document.getElementById('linkSpeed').value);

  console.log('addLink called', { name, address, coordinates, speed });

  if (!name || !address || !speed || speed < 40 || speed > 10000) {
      alert('Por favor, preencha todos os campos obrigat√≥rios. A velocidade deve estar entre 40 e 10.000 Mbps.');
      return;
  }

  try {
    const { data, error } = await supabase.from('links').insert([{ name, address, coordinates, speed }]).select();
    if (error) throw error;

    clearForm();
    await loadLinks();
    alert(`Link "${name}" adicionado com sucesso!`);
  } catch (err) {
    console.error('Erro ao inserir link', err);
    alert('Erro ao salvar no banco: ' + (err.message || JSON.stringify(err)));
  }
}

async function removeLink(id) {
  try {
    const { error } = await supabase.from('links').delete().eq('id', id);
    if (error) throw error;

    links = links.filter(link => link.id !== id);
    updateDisplay();
  } catch (err) {
    console.error('removeLink error', err);
    alert('Erro ao remover link: ' + (err.message || JSON.stringify(err)));
  }
}

async function saveLink(id) {
  const speedInput = document.getElementById(`speed-${id}`);
  const newSpeed = parseInt(speedInput.value);

  if (newSpeed < 40 || newSpeed > 10000) {
    alert('A velocidade deve estar entre 40 e 10.000 Mbps.');
    return;
  }

  try {
    const { error } = await supabase.from('links').update({ speed: newSpeed }).eq('id', id);
    if (error) throw error;

    const link = links.find(l => l.id === id);
    if (link) link.speed = newSpeed;
    updateDisplay();
    alert(`Velocidade do link "${link ? link.name : id}" atualizada para ${newSpeed} Mbps!`);
  } catch (err) {
    console.error('saveLink error', err);
    alert('Erro ao atualizar velocidade: ' + (err.message || JSON.stringify(err)));
  }
}

/* =========================
   DISPLAY / UI de Links
   ========================= */
function updateDisplay() {
  const totalLinks = links.length;
  const externalBandwidth = links.reduce((sum, link) => sum + (link.speed || 0), 0);
  const hotspotBandwidth = hotspotLinks.filter(link => link.isActive).reduce((sum, link) => sum + (link.speed || 0), 0);
  const itinerantBandwidth = itinerantLinks.reduce((sum, link) =>
      link.isActive ? sum + (link.subLinks ? link.subLinks.filter(sl => sl.enabled).reduce((s, sl) => s + (sl.speed || 0), 0) : 0) : sum
    , 0);
  const totalBandwidth = externalBandwidth + hotspotBandwidth + itinerantBandwidth;

  // Ajustar concentrador automaticamente baseado em capacidades predefinidas
  if (totalBandwidth > 0) {
    const availableCapacities = [100,200,300,400,500,600,700,800,900,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000];
    const requiredCapacity = availableCapacities.find(capacity => capacity >= totalBandwidth);
    concentratorCapacity = requiredCapacity || 10000;
  } else {
    concentratorCapacity = 100;
  }

  document.getElementById('totalLinks').textContent = totalLinks;
  document.getElementById('totalBandwidth').textContent = totalBandwidth;
  document.getElementById('concentratorCapacity').textContent = concentratorCapacity;

  const needsUpgrade = totalBandwidth > 10000;
  const upgradeStatus = document.getElementById('upgradeStatus');
  const capacityAlert = document.getElementById('capacityAlert');
  const alertMessage = document.getElementById('alertMessage');

  if (needsUpgrade) {
    upgradeStatus.textContent = '‚ö†Ô∏è';
    upgradeStatus.className = 'text-lg font-bold text-red-600';
    capacityAlert.classList.remove('hidden');
    alertMessage.textContent = `A demanda total (${totalBandwidth} Mbps) excede a capacidade m√°xima do sistema (10.000 Mbps). Necess√°rio expandir infraestrutura.`;
  } else if (totalBandwidth > 0) {
    upgradeStatus.textContent = '‚úÖ';
    upgradeStatus.className = 'text-lg font-bold text-green-600';
    capacityAlert.classList.add('hidden');
  } else {
    upgradeStatus.textContent = '‚ûñ';
    upgradeStatus.className = 'text-lg font-bold text-gray-400';
    capacityAlert.classList.add('hidden');
  }

  updateLinksList();
}

function updateLinksList() {
  const linksList = document.getElementById('linksList');

  if (links.length === 0) {
    linksList.innerHTML = '<div class="text-gray-400 text-center py-8">Nenhum link cadastrado ainda</div>';
    return;
  }

  linksList.innerHTML = links.map(link => `
    <div class="border border-gray-600 rounded-lg p-4 bg-gray-700">
      <div class="flex justify-between items-start">
        <div class="flex-grow">
          <h4 class="font-medium text-lg text-gray-100">${link.name}</h4>
          <p class="text-sm text-gray-300 mt-1">üìç ${link.address}</p>
          ${link.coordinates ? `<p class="text-sm text-gray-300">üåê ${link.coordinates}</p>` : ''}
          <p class="text-sm text-gray-300">üìÖ Cadastrado em: ${link.dateCreated || ''}</p>
          <div class="flex items-center gap-2 mt-2">
            <span class="text-sm text-gray-300">Velocidade:</span>
            <input type="number" value="${link.speed}" min="40" max="10000"
                   id="speed-${link.id}"
                   class="w-20 border border-gray-500 rounded px-2 py-1 text-sm bg-gray-600 text-white focus:border-blue-400 focus:outline-none">
            <span class="text-sm text-gray-300">Mbps</span>
            <button onclick="saveLink(${link.id})"
                    class="px-3 py-1 text-xs rounded bg-green-500 text-white hover:bg-green-600 transition">
              üíæ Salvar
            </button>
          </div>
        </div>
        <div class="flex flex-col gap-2 ml-4">
          <button onclick="exportLinkToPDF(${link.id})"
                  class="px-3 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600 transition">
            üìÑ PDF
          </button>
          <button onclick="removeLink(${link.id})"
                  class="px-3 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600 transition">
            üóëÔ∏è Excluir
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function clearForm() {
  if (document.getElementById('linkName')) document.getElementById('linkName').value = '';
  if (document.getElementById('linkAddress')) document.getElementById('linkAddress').value = '';
  if (document.getElementById('linkCoordinates')) document.getElementById('linkCoordinates').value = '';
  if (document.getElementById('linkSpeed')) document.getElementById('linkSpeed').value = '40';
}

/* =========================
   LINKS ITINERANTES
   ========================= */
async function loadItinerantLinks() {
  try {
    const { data: linksData, error: errLinks } = await supabase.from('itinerant_links').select('*').order('date_created',{ascending:true});
    if (errLinks) throw errLinks;

    const { data: sublinksData, error: errSublinks } = await supabase.from('itinerant_sublinks').select('*').order('id', { ascending: true });
    if (errSublinks) throw errSublinks;

    const grouped = {};
    (sublinksData || []).forEach(s => {
      if (!grouped[s.itinerant_id]) grouped[s.itinerant_id] = [];
      grouped[s.itinerant_id].push({
        id: s.id,
        name: s.name,
        speed: s.speed,
        enabled: s.enabled
      });
    });

    itinerantLinks = (linksData || []).map(r => ({
      id: r.id,
      name: r.name,
      location: r.location,
      coordinates: r.coordinates,
      period: r.period,
      isActive: r.is_active,
      isPublic: r.is_public,
      needsWifi: r.needs_wifi,
      needsLan: r.needs_lan,
      wifiSSID: r.wifi_ssid,
      wifiPassword: r.wifi_password,
      subLinks: grouped[r.id] || [],
      dateCreated: r.date_created ? new Date(r.date_created).toLocaleDateString('pt-BR') : ''
    }));

    updateItinerantDisplay();
  } catch (err) {
    console.error('loadItinerantLinks error', err);
  }
}

async function addItinerantLink() {
  const name = document.getElementById('itinerantLinkName').value.trim();
  const location = document.getElementById('itinerantLocation').value.trim();
  const coordinates = document.getElementById('itinerantCoordinates').value.trim() || null;
  const period = document.getElementById('itinerantPeriodInput').value.trim();
  const isPublic = document.getElementById('itinerantPublicCheck').checked;
  const needsWifi = document.getElementById('itinerantWifiCheck').checked;
  const needsLan = document.getElementById('itinerantLanCheck').checked;
  const wifiSSID = document.getElementById('wifiSSID').value.trim();
  const wifiPassword = document.getElementById('wifiPassword').value.trim();

  if (!name || !location || !period) {
    alert('Por favor, preencha todos os campos obrigat√≥rios.');
    return;
  }

  if (needsWifi && (!wifiSSID || !wifiPassword)) {
    alert('Por favor, preencha o SSID e senha do Wi-Fi.');
    return;
  }

  try {
    const { data, error } = await supabase.from('itinerant_links').insert([{
      name, location, coordinates, period,
      is_public: isPublic, needs_wifi: needsWifi, needs_lan: needsLan,
      wifi_ssid: wifiSSID || null, wifi_password: wifiPassword || null
    }]).select();

    if (error) throw error;
    const inserted = (data || [])[0];

    // criar 100 sublinks para este itinerant (padr√£o)
    const sublinksToInsert = Array.from({length: 100}, (_, i) => ({
      itinerant_id: inserted.id,
      name: `Sub-Link ${i + 1}`,
      speed: 100,
      enabled: false
    }));
    if (sublinksToInsert.length) {
      const { error: errS } = await supabase.from('itinerant_sublinks').insert(sublinksToInsert);
      if (errS) throw errS;
    }

    await loadItinerantLinks();
    clearItinerantForm();
    alert('Link itinerante criado com sucesso!');
  } catch (err) {
    console.error('addItinerantLink error', err);
    alert('Erro ao criar link itinerante: ' + (err.message || JSON.stringify(err)));
  }
}

async function removeItinerantLink(id) {
  try {
    const { error } = await supabase.from('itinerant_links').delete().eq('id', id);
    if (error) throw error;
    itinerantLinks = itinerantLinks.filter(link => link.id !== id);
    updateItinerantDisplay();
  } catch (err) {
    console.error('removeItinerantLink error', err);
    alert('Erro ao remover link itinerante: ' + (err.message || JSON.stringify(err)));
  }
}

function toggleWifiConfig() {
  const isChecked = document.getElementById('itinerantWifiCheck').checked;
  const wifiConfig = document.getElementById('wifiConfig');
  if (isChecked) {
    wifiConfig.classList.remove('hidden');
  } else {
    wifiConfig.classList.add('hidden');
    document.getElementById('wifiSSID').value = '';
    document.getElementById('wifiPassword').value = '';
  }
}

function toggleItinerantLink(id) {
  const link = itinerantLinks.find(l => l.id === id);
  if (!link) return;
  link.isActive = !link.isActive;
  supabase.from('itinerant_links').update({ is_active: link.isActive }).eq('id', id)
    .then(res => { if (res.error) console.error('toggleItinerantLink error', res.error); });
  updateItinerantDisplay();
}

async function saveItinerantLink(linkId) {
  const sublinkSelect = document.getElementById(`sublinks-${linkId}`);
  const quantity = parseInt(sublinkSelect.value);

  try {
    const { error: err0 } = await supabase.from('itinerant_sublinks').update({ enabled: false }).eq('itinerant_id', linkId);
    if (err0) throw err0;

    if (quantity > 0) {
      const { data: firstN, error: err1 } = await supabase.from('itinerant_sublinks')
        .select('id')
        .eq('itinerant_id', linkId)
        .order('id', { ascending: true })
        .limit(quantity);

      if (err1) throw err1;
      const ids = (firstN || []).map(s => s.id);
      if (ids.length) {
        const { error: err2 } = await supabase.from('itinerant_sublinks').update({ enabled: true }).in('id', ids);
        if (err2) throw err2;
      }
    }

    await loadItinerantLinks();
    updateDisplay();
    alert(`Link itinerante atualizado para ${quantity} sub-links (${quantity * 100} Mbps)!`);
  } catch (err) {
    console.error('saveItinerantLink error', err);
    alert('Erro ao salvar configura√ß√£o de sub-links: ' + (err.message || JSON.stringify(err)));
  }
}

function updateItinerantDisplay() {
  const totalItinerantLinks = itinerantLinks.length;
  const activeItinerantLinks = itinerantLinks.filter(link => link.isActive).length;
  const totalSubLinks = itinerantLinks.reduce((sum, link) =>
    sum + (link.subLinks ? link.subLinks.filter(sl => sl.enabled).length : 0), 0);
  const totalItinerantBandwidth = itinerantLinks.reduce((sum, link) =>
    sum + (link.isActive ? (link.subLinks ? link.subLinks.filter(sl => sl.enabled).reduce((s, sl) => s + (sl.speed || 0), 0) : 0) : 0), 0);

  document.getElementById('totalItinerantLinks').textContent = totalItinerantLinks;
  document.getElementById('activeItinerantLinks').textContent = activeItinerantLinks;
  document.getElementById('totalSubLinks').textContent = totalSubLinks;
  document.getElementById('totalItinerantBandwidth').textContent = totalItinerantBandwidth;

  updateItinerantLinksList();
}

function updateItinerantLinksList() {
  const itinerantLinksList = document.getElementById('itinerantLinksList');

  if (itinerantLinks.length === 0) {
    itinerantLinksList.innerHTML = '<div class="text-gray-500 text-center py-8">Nenhum link itinerante cadastrado ainda</div>';
    return;
  }

  itinerantLinksList.innerHTML = itinerantLinks.map(link => {
    const activeSubLinks = link.subLinks ? link.subLinks.filter(sl => sl.enabled).length : 0;
    const totalBandwidth = link.subLinks ? link.subLinks.filter(sl => sl.enabled).reduce((sum, sl) => sum + (sl.speed || 0), 0) : 0;

    return `
      <div class="border rounded-lg p-6 ${link.isActive ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}">
        <div class="flex justify-between items-start mb-4">
          <div class="flex-grow">
            <h4 class="text-lg font-semibold">${link.name}</h4>
            <p class="text-sm text-gray-600">üìç ${link.location}</p>
            ${link.coordinates ? `<p class="text-sm text-gray-600">üåê ${link.coordinates}</p>` : ''}
            <p class="text-sm text-gray-600">üìÖ ${link.period}</p>
            <div class="mt-2 space-y-1">
              <div>
                <span class="inline-block px-2 py-1 text-xs rounded ${link.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                  ${link.isActive ? '‚úÖ Ativo' : '‚è∏Ô∏è Inativo'}
                </span>
                <span class="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 ml-2">
                  ${activeSubLinks}/100 Sub-Links
                </span>
                <span class="inline-block px-2 py-1 text-xs rounded bg-purple-100 text-purple-800 ml-2">
                  ${totalBandwidth} Mbps
                </span>
              </div>
              <div>
                ${link.isPublic ? '<span class="inline-block px-2 py-1 text-xs rounded bg-orange-100 text-orange-800">üë• P√∫blico</span>' : '<span class="inline-block px-2 py-1 text-xs rounded bg-gray-100 text-gray-600">üîí Privado</span>'}
                ${link.needsWifi ? `<span class="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 ml-2">üì∂ Wi-Fi: ${link.wifiSSID}</span>` : ''}
                ${link.needsLan ? '<span class="inline-block px-2 py-1 text-xs rounded bg-green-100 text-green-800 ml-2">üîå Cabo LAN</span>' : ''}
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-2 ml-4">
            <button onclick="exportItinerantLinkToPDF(${link.id})"
                    class="px-3 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600 transition">
              üìÑ PDF
            </button>
            <button onclick="toggleItinerantLink(${link.id})"
                    class="px-3 py-1 text-xs rounded transition ${link.isActive ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-green-500 text-white hover:bg-green-600'}">
              ${link.isActive ? '‚è∏Ô∏è Desativar' : '‚ñ∂Ô∏è Ativar'}
            </button>
            <button onclick="removeItinerantLink(${link.id})"
                    class="px-3 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600 transition">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>

        <div class="border-t pt-4">
          <h5 class="font-medium mb-3 text-gray-200">Configura√ß√£o de Sub-Links:</h5>
          <div class="bg-gray-700 p-4 rounded-lg">
            <div class="flex items-center gap-4 mb-3">
              <label class="text-sm font-medium text-gray-200">Quantidade de Sub-Links Ativos:</label>
              <select id="sublinks-${link.id}" class="border border-gray-500 rounded px-3 py-2 bg-gray-700 text-white min-w-[120px] focus:border-blue-400 focus:outline-none">
                ${Array.from({length: 101}, (_, i) => `<option value="${i}" ${activeSubLinks === i ? 'selected' : ''}>${i} Sub-Links</option>`).join('')}
              </select>
              <span class="text-sm text-gray-200">= ${totalBandwidth} Mbps</span>
              <button onclick="saveItinerantLink(${link.id})"
                      class="px-3 py-1 text-xs rounded bg-green-500 text-white hover:bg-green-600 transition">
                üíæ Salvar
              </button>
            </div>

            <div class="bg-gray-600 p-3 rounded mt-3">
              <div class="text-xs text-gray-300 mb-2">
                Sub-Links Ativos: ${activeSubLinks}/100 (cada sub-link = 100 Mbps)
              </div>
              <div class="w-full bg-gray-500 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full" style="width: ${(activeSubLinks / 100) * 100}%"></div>
              </div>
              <div class="text-xs text-gray-300 mt-1">
                ${activeSubLinks > 0 ? `${activeSubLinks} √ó 100 Mbps = ${totalBandwidth} Mbps` : 'Nenhum sub-link ativo'}
              </div>
            </div>

            <div class="text-xs text-gray-300 mt-2">
              Cada sub-link fornece 100 Mbps. Selecione quantos deseja ativar (m√°ximo: 100).
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function clearItinerantForm() {
  document.getElementById('itinerantLinkName').value = '';
  document.getElementById('itinerantLocation').value = '';
  document.getElementById('itinerantCoordinates').value = '';
  document.getElementById('itinerantPeriodInput').value = '';

  document.getElementById('itinerantPublicCheck').checked = false;
  document.getElementById('itinerantWifiCheck').checked = false;
  document.getElementById('itinerantLanCheck').checked = false;
  document.getElementById('wifiSSID').value = '';
  document.getElementById('wifiPassword').value = '';
  document.getElementById('wifiConfig').classList.add('hidden');
}

/* =========================
   HOTSPOTS
   ========================= */
async function loadHotspots() {
  try {
    const { data, error } = await supabase.from('hotspots').select('*').order('date_created',{ascending:true});
    if (error) throw error;

    hotspotLinks = (data || []).map(r => ({
      id: r.id,
      name: r.name,
      address: r.address,
      coordinates: r.coordinates,
      dateCreated: r.date_created ? new Date(r.date_created).toLocaleDateString('pt-BR') : '',
      isActive: r.is_active,
      speed: r.speed
    }));

    updateHotspotDisplay();
  } catch (err) {
    console.error('loadHotspots error', err);
  }
}

async function addHotspotLink() {
  const name = document.getElementById('hotspotLinkName').value.trim();
  const address = document.getElementById('hotspotAddress').value.trim();
  const coordinates = document.getElementById('hotspotCoordinates').value.trim();

  if (!name || !address || !coordinates) {
    alert('Por favor, preencha todos os campos obrigat√≥rios.');
    return;
  }

  try {
    const { error } = await supabase.from('hotspots').insert([{ name, address, coordinates, speed: 1000 }]);
    if (error) throw error;

    await loadHotspots();
    updateDisplay();
    clearHotspotForm();
    alert('Hotspot cadastrado com sucesso!');
  } catch (err) {
    console.error('addHotspotLink error', err);
    alert('Erro ao cadastrar hotspot: ' + (err.message || JSON.stringify(err)));
  }
}

async function removeHotspotLink(id) {
  try {
    const { error } = await supabase.from('hotspots').delete().eq('id', id);
    if (error) throw error;
    hotspotLinks = hotspotLinks.filter(link => link.id !== id);
    updateHotspotDisplay();
    updateDisplay();
  } catch (err) {
    console.error('removeHotspotLink error', err);
    alert('Erro ao remover hotspot: ' + (err.message || JSON.stringify(err)));
  }
}

function toggleHotspotLink(id) {
  const link = hotspotLinks.find(l => l.id === id);
  if (!link) return;
  link.isActive = !link.isActive;
  supabase.from('hotspots').update({ is_active: link.isActive }).eq('id', id)
    .then(res => { if (res.error) console.error('toggleHotspotLink error', res.error); });

  updateHotspotDisplay();
  updateDisplay();
}

function updateHotspotDisplay() {
  const totalHotspotLinks = hotspotLinks.length;
  const activeHotspotLinks = hotspotLinks.filter(link => link.isActive).length;
  const totalHotspotLocations = hotspotLinks.length;
  const hotspotCoverage = totalHotspotLinks > 0 ? Math.round((activeHotspotLinks / totalHotspotLinks) * 100) : 0;

  document.getElementById('totalHotspotLinks').textContent = totalHotspotLinks;
  document.getElementById('activeHotspotLinks').textContent = activeHotspotLinks;
  document.getElementById('totalHotspotLocations').textContent = totalHotspotLocations;
  document.getElementById('hotspotCoverage').textContent = hotspotCoverage;

  updateHotspotLinksList();
}

function updateHotspotLinksList() {
  const hotspotLinksList = document.getElementById('hotspotLinksList');

  if (hotspotLinks.length === 0) {
    hotspotLinksList.innerHTML = '<div class="text-gray-500 text-center py-8">Nenhum hotspot cadastrado ainda</div>';
    return;
  }

  hotspotLinksList.innerHTML = hotspotLinks.map(link => `
    <div class="border rounded-lg p-6 ${link.isActive ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}">
      <div class="flex justify-between items-start">
        <div class="flex-grow">
          <h4 class="text-lg font-semibold">${link.name}</h4>
          <p class="text-sm text-gray-600 mt-1">üìç ${link.address}</p>
          <p class="text-sm text-gray-600">üåê ${link.coordinates}</p>
          <p class="text-sm text-gray-600">üìÖ Cadastrado em: ${link.dateCreated}</p>
          <div class="mt-2">
            <span class="inline-block px-2 py-1 text-xs rounded ${link.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
              ${link.isActive ? '‚úÖ Ativo' : '‚è∏Ô∏è Inativo'}
            </span>
            <span class="inline-block px-2 py-1 text-xs rounded bg-orange-100 text-orange-800 ml-2">
              üì∂ Wi-Fi P√∫blico
            </span>
            <span class="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 ml-2">
              üë• 125-250 usu√°rios
            </span>
            <span class="inline-block px-2 py-1 text-xs rounded bg-purple-100 text-purple-800 ml-2">
              ‚ö° ${link.speed || 1000} Mbps
            </span>
          </div>
        </div>
        <div class="flex flex-col gap-2 ml-4">
          <button onclick="exportHotspotLinkToPDF(${link.id})"
                  class="px-3 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600 transition">
            üìÑ PDF
          </button>
          <button onclick="toggleHotspotLink(${link.id})"
                  class="px-3 py-1 text-xs rounded transition ${link.isActive ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-green-500 text-white hover:bg-green-600'}">
            ${link.isActive ? '‚è∏Ô∏è Desativar' : '‚ñ∂Ô∏è Ativar'}
          </button>
          <button onclick="removeHotspotLink(${link.id})"
                  class="px-3 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600 transition">
            üóëÔ∏è Excluir
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function clearHotspotForm() {
  document.getElementById('hotspotLinkName').value = '';
  document.getElementById('hotspotAddress').value = '';
  document.getElementById('hotspotCoordinates').value = '';
}

/* =========================
   EXPORTS (jsPDF / CSV)
   Mantive as fun√ß√µes de export que j√° estavam no seu c√≥digo original
   ========================= */

function exportToPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('Relat√≥rio de Links - Prefeitura de Gua√≠ba', 20, 20);
    doc.setFontSize(12);
    doc.text('Preg√£o Eletr√¥nico 71/2022', 20, 30);
    let y = 50;
    doc.text(`Total de Links: ${links.length}`, 20, y);
    y += 10;
    doc.text(`Banda Total: ${links.reduce((sum, link) => sum + link.speed, 0)} Mbps`, 20, y);
    y += 10;
    doc.text(`Concentrador: ${concentratorCapacity} Mbps`, 20, y);
    y += 20;
    doc.text('Links Cadastrados:', 20, y);
    y += 10;
    links.forEach(link => {
      doc.text(`‚Ä¢ ${link.name}: ${link.speed} Mbps`, 25, y);
      y += 8;
    });
    y += 10;
    doc.text('Configura√ß√µes:', 20, y);
    y += 10;
    doc.text(`SLA: ${config.sla}%`, 25, y);
    y += 8;
    doc.text(`Redund√¢ncia: ${config.redundancy ? 'Ativa' : 'Inativa'}`, 25, y);
    y += 8;
    doc.text(`Link Itinerante: ${config.itinerant ? 'Ativo' : 'Inativo'}`, 25, y);
    doc.save('relatorio-links-guaiba.pdf');
  } catch (err) {
    console.error('exportToPDF error', err);
    alert('Erro ao exportar PDF: ' + (err.message || JSON.stringify(err)));
  }
}

function exportToCSV() {
  try {
    let csv = 'Nome do Link,Velocidade (Mbps)\n';
    links.forEach(link => {
      csv += `"${link.name}",${link.speed}\n`;
    });
    csv += '\nResumo:\n';
    csv += `Total de Links,${links.length}\n`;
    csv += `Banda Total,${links.reduce((sum, link) => sum + link.speed, 0)}\n`;
    csv += `Concentrador,${concentratorCapacity}\n`;
    csv += `SLA,${config.sla}%\n`;
    csv += `Redund√¢ncia,${config.redundancy ? 'Ativa' : 'Inativa'}\n`;
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'links-guaiba.csv';
    a.click();
    window.URL.revokeObjectURL(url);
  } catch (err) {
    console.error('exportToCSV error', err);
    alert('Erro ao exportar CSV: ' + (err.message || JSON.stringify(err)));
  }
}

/* =========================
   Fun√ß√µes individuais de export (mantive a mesma l√≥gica)
   ========================= */
// exportLinkToPDF, exportItinerantToPDF, exportHotspotToPDF etc.
// (Se quiser eu reescrevo aqui tamb√©m ‚Äî mantive as originais no seu HTML, mas se
// voc√™ preferir, adiciono todas as vers√µes completas aqui tamb√©m.)

/* =========================
   WRAPPERS PARA BOT√ïES
   ========================= */

// Troca de pain√©is
function showPanel(panel) {
  document.getElementById("itinerantPanel").classList.add("hidden");
  document.getElementById("hotspotPanel").classList.add("hidden");

  if (panel === "main") {
    // Painel principal j√° est√° vis√≠vel no HTML
  } else if (panel === "itinerant") {
    document.getElementById("itinerantPanel").classList.remove("hidden");
  } else if (panel === "hotspot") {
    document.getElementById("hotspotPanel").classList.remove("hidden");
  }
}

// Exporta√ß√µes individuais
function exportLinkToPDF(id) {
  alert("Exportar Link " + id + " para PDF (implementar se desejar)");
}
function exportItinerantToPDF() {
  exportToPDF(); // usa o export geral
}
function exportItinerantToCSV() {
  exportToCSV(); // usa o export geral
}
function exportHotspotToPDF() {
  exportToPDF();
}
function exportHotspotToCSV() {
  exportToCSV();
}

/* =========================
   EXPORTAR PDF INDIVIDUAL
   ========================= */

// Exporta apenas UM link externo
function exportLinkToPDF(id) {
  const link = links.find(l => l.id === id);
  if (!link) {
    alert("Link n√£o encontrado!");
    return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Relat√≥rio de Link Externo", 20, 20);
    doc.setFontSize(12);
    doc.text(`Nome: ${link.name}`, 20, 40);
    doc.text(`Endere√ßo: ${link.address}`, 20, 50);
    if (link.coordinates) doc.text(`Coordenadas: ${link.coordinates}`, 20, 60);
    doc.text(`Velocidade: ${link.speed} Mbps`, 20, 70);
    doc.text(`Data de Cadastro: ${link.dateCreated}`, 20, 80);

    doc.save(`link-${link.id}.pdf`);
  } catch (err) {
    console.error("exportLinkToPDF error", err);
    alert("Erro ao exportar PDF: " + (err.message || JSON.stringify(err)));
  }
}

// Exporta todos os links itinerantes
function exportItinerantToPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Relat√≥rio de Links Itinerantes", 20, 20);

    let y = 40;
    itinerantLinks.forEach(link => {
      doc.setFontSize(12);
      doc.text(`Nome: ${link.name}`, 20, y);
      y += 8;
      doc.text(`Localiza√ß√£o: ${link.location}`, 20, y);
      y += 8;
      doc.text(`Per√≠odo: ${link.period}`, 20, y);
      y += 8;
      doc.text(`Sub-Links Ativos: ${link.subLinks.filter(sl => sl.enabled).length}`, 20, y);
      y += 12;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save("links-itinerantes.pdf");
  } catch (err) {
    console.error("exportItinerantToPDF error", err);
    alert("Erro ao exportar PDF: " + (err.message || JSON.stringify(err)));
  }
}

// Exporta todos os hotspots
function exportHotspotToPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Relat√≥rio de Hotspots", 20, 20);

    let y = 40;
    hotspotLinks.forEach(link => {
      doc.setFontSize(12);
      doc.text(`Nome: ${link.name}`, 20, y);
      y += 8;
      doc.text(`Endere√ßo: ${link.address}`, 20, y);
      y += 8;
      doc.text(`Coordenadas: ${link.coordinates}`, 20, y);
      y += 8;
      doc.text(`Velocidade: ${link.speed || 1000} Mbps`, 20, y);
      y += 12;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    doc.save("hotspots.pdf");
  } catch (err) {
    console.error("exportHotspotToPDF error", err);
    alert("Erro ao exportar PDF: " + (err.message || JSON.stringify(err)));
  }
}

/* =========================
   EXPORTAR PDF PADR√ÉO
   ========================= */

// LINK EXTERNO
function exportLinkToPDF(id) {
  const link = links.find(l => l.id === id);
  if (!link) {
    alert("Link n√£o encontrado!");
    return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Cabe√ßalho
    doc.setFontSize(16);
    doc.text("Relat√≥rio de Link Externo - Prefeitura de Gua√≠ba", 20, 20);
    doc.setFontSize(12);
    doc.text("Preg√£o Eletr√¥nico 71/2022", 20, 30);

    // Informa√ß√µes do link
    let y = 50;
    doc.setFontSize(12);
    doc.text("Informa√ß√µes do Link:", 20, y); y += 10;
    doc.text(`Nome: ${link.name}`, 20, y); y += 8;
    doc.text(`Endere√ßo: ${link.address}`, 20, y); y += 8;
    if (link.coordinates) { doc.text(`Coordenadas: ${link.coordinates}`, 20, y); y += 8; }
    doc.text(`Velocidade: ${link.speed} Mbps`, 20, y); y += 8;
    doc.text(`Data de Cadastro: ${link.dateCreated}`, 20, y); y += 15;

    // Equipamentos Necess√°rios
    doc.text("Equipamentos Necess√°rios:", 20, y); y += 10;
    doc.text("‚Ä¢ PONTO COM NOBREAK", 25, y); y += 8;
    doc.text("‚Ä¢ MIKROTIK", 25, y); y += 8;
    doc.text("‚Ä¢ ONU", 25, y); y += 8;
    doc.text("‚Ä¢ RACK", 25, y); y += 15;

    // Observa√ß√µes
    doc.text("Observa√ß√µes:", 20, y); y += 10;
    doc.text("Este link externo foi configurado conforme especifica√ß√µes", 25, y); y += 8;
    doc.text("do Preg√£o Eletr√¥nico 71/2022 da Prefeitura de Gua√≠ba.", 25, y); y += 8;
    doc.text("Todos os equipamentos listados s√£o obrigat√≥rios para", 25, y); y += 8;
    doc.text("o funcionamento adequado do link.", 25, y);

    // Salvar PDF
    doc.save(`link-externo-${link.name.replace(/\s+/g, "_")}.pdf`);
  } catch (err) {
    console.error("exportLinkToPDF error", err);
    alert("Erro ao exportar PDF: " + (err.message || JSON.stringify(err)));
  }
}


// LINK ITINERANTE
function exportItinerantLinkToPDF(id) {
  const link = itinerantLinks.find(l => l.id === id);
  if (!link) {
    alert("Link itinerante n√£o encontrado!");
    return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Cabe√ßalho
    doc.setFontSize(16);
    doc.text("Relat√≥rio de Link Itinerante - Prefeitura de Gua√≠ba", 20, 20);
    doc.setFontSize(12);
    doc.text("Preg√£o Eletr√¥nico 71/2022", 20, 30);

    // Informa√ß√µes do link itinerante
    let y = 50;
    doc.setFontSize(12);
    doc.text("Informa√ß√µes do Link Itinerante:", 20, y); y += 10;
    doc.text(`Nome: ${link.name}`, 20, y); y += 8;
    doc.text(`Localiza√ß√£o: ${link.location}`, 20, y); y += 8;
    if (link.coordinates) { doc.text(`Coordenadas: ${link.coordinates}`, 20, y); y += 8; }
    doc.text(`Per√≠odo: ${link.period}`, 20, y); y += 8;
    doc.text(`Status: ${link.isActive ? "Ativo" : "Inativo"}`, 20, y); y += 8;
    doc.text(`Acesso: ${link.isPublic ? "P√∫blico" : "Privado"}`, 20, y); y += 8;
    doc.text(`Wi-Fi: ${link.needsWifi ? "Sim" : "N√£o"}`, 20, y); y += 8;
    if (link.needsWifi) {
      doc.text(`SSID: ${link.wifiSSID}`, 25, y); y += 8;
      doc.text(`Senha: ${link.wifiPassword}`, 25, y); y += 8;
    }
    doc.text(`Cabo LAN: ${link.needsLan ? "Sim" : "N√£o"}`, 20, y); y += 15;

    // Configura√ß√£o de Sub-links
    const activeSubLinks = link.subLinks ? link.subLinks.filter(sl => sl.enabled).length : 0;
    const totalBandwidth = activeSubLinks * 100;
    doc.text("Configura√ß√£o de Sub-Links:", 20, y); y += 10;
    doc.text(`Sub-Links Ativos: ${activeSubLinks}/100`, 20, y); y += 8;
    doc.text(`Velocidade Total: ${totalBandwidth} Mbps`, 20, y); y += 8;
    doc.text("Cada sub-link fornece 100 Mbps", 20, y); y += 15;

    // Valor de Cobran√ßa
    doc.text("Valor de Cobran√ßa:", 20, y); y += 10;
    doc.text(`Quantidade de Links Unificados: ${activeSubLinks}`, 20, y); y += 8;
    doc.text("Valor ser√° cobrado com base na quantidade de links ativos", 20, y); y += 8;
    doc.text("conforme especificado no contrato do Preg√£o 71/2022.", 20, y);

    // Salvar PDF
    doc.save(`link-itinerante-${link.name.replace(/\s+/g, "_")}.pdf`);
  } catch (err) {
    console.error("exportItinerantLinkToPDF error", err);
    alert("Erro ao exportar PDF: " + (err.message || JSON.stringify(err)));
  }
}

</script>

